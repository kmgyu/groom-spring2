<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="goorm.mybatisboard.post.mapper.PostMapper">

    <select id="findAll" resultType="goorm.mybatisboard.post.model.Post">
        SELECT id, title, content, created_at, updated_at
        FROM posts
        ORDER BY created_at DESC
    </select>

    <select id="findAllWithPage" resultType="goorm.mybatisboard.post.model.Post">
        SELECT id, title, content, created_at, updated_at
        FROM posts
        ORDER BY created_at DESC
        LIMIT #{offset}, #{size}
    </select>

    <select id="findAllWithSearch" resultType="Post">
        SELECT id, title, content, created_at, updated_at
        FROM posts
        <where>
            <if test="keyword != null and keyword.trim() != ''">
                <choose>
                    <when test="searchType == 'title'">
                        title LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <when test="searchType == 'content'">
                        content LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <otherwise>
                        (  title LIKE CONCAT('%', #{keyword}, '%')
                        OR content LIKE CONCAT('%', #{keyword}, '%') )
                    </otherwise>
                </choose>
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{size}
    </select>

    <select id="countAll" resultType="int">
        SELECT COUNT(id)
        FROM posts
    </select>

    <select id="countAllWithSearch" resultType="int">
        SELECT COUNT(id)
        FROM posts
        <where>
            <if test="keyword != null and keyword.trim() != ''">
                <choose>
                    <when test="searchType == 'title'">
                        title LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <when test="searchType == 'content'">
                        content LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <otherwise>
                        (  title LIKE CONCAT('%', #{keyword}, '%')
                        OR content LIKE CONCAT('%', #{keyword}, '%') ))
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>

    <select id="findById" parameterType="long" resultType="goorm.mybatisboard.post.model.Post">
        SELECT id, title, content, created_at, updated_at,
               category_id, status, author_name, view_count, is_notice
        FROM posts
        WHERE id = #{id}
    </select>

    <insert id="save" parameterType="goorm.mybatisboard.post.model.Post" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO posts (title, content, created_at, updated_at,
                           category_id, status, author_name, view_count, is_notice)
        VALUES (#{title}, #{content}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="update">
        UPDATE posts 
        SET title = #{post.title}, 
            content = #{post.content}, 
            updated_at = #{post.updatedAt},
            category_id = #{post.categoryId},
            status = #{post.status},
            author_name = #{post.authorName},
            view_count = #{post.viewCount},
            is_notice = #{post.isNotice}
        WHERE id = #{id}
    </update>

    <delete id="delete" parameterType="long">
        DELETE FROM posts 
        WHERE id = #{id}
    </delete>

    <!-- ========== 통합 검색 쿼리 ========== -->

    <!-- 통합 검색 - 모든 조건을 SearchConditionDto로 처리 -->
    <select id="findAllWithConditions" parameterType="goorm.mybatisboard.post.dto.SearchConditionDto"
            resultType="goorm.mybatisboard.post.dto.PostDetailDto">
        SELECT
        p.id,
        p.title,
        p.content,
        p.created_at,
        p.updated_at,
        'PUBLISHED' as status,
        '작성자' as author_name,
        0 as view_count,
        FALSE as is_notice,
        1 as category_id,
        '일반' as category_name
        FROM posts p

        <where>
            <!-- 키워드 검색 -->
            <if test="keyword != null and keyword.trim() != ''">
                AND (
                <choose>
                    <when test="searchType == 'title'">
                        LOWER(p.title) LIKE LOWER(CONCAT('%', #{keyword}, '%'))
                    </when>
                    <when test="searchType == 'content'">
                        LOWER(p.content) LIKE LOWER(CONCAT('%', #{keyword}, '%'))
                    </when>
                    <otherwise>
                        (LOWER(p.title) LIKE LOWER(CONCAT('%', #{keyword}, '%'))
                        OR LOWER(p.content) LIKE LOWER(CONCAT('%', #{keyword}, '%')))
                    </otherwise>
                </choose>
                )
            </if>

            <!-- 날짜 범위 검색 -->
            <if test="startDate != null">
                AND DATE(p.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(p.created_at) &lt;= #{endDate}
            </if>
        </where>

        <!-- 동적 정렬 -->
        ORDER BY
        <choose>
            <when test="sortBy == 'title' and sortDirection == 'ASC'">
                p.title ASC
            </when>
            <when test="sortBy == 'title' and sortDirection == 'DESC'">
                p.title DESC
            </when>
            <when test="sortBy == 'view_count' and sortDirection == 'ASC'">
                p.view_count ASC
            </when>
            <when test="sortBy == 'view_count' and sortDirection == 'DESC'">
                p.view_count DESC
            </when>
            <when test="sortBy == 'author_name' and sortDirection == 'ASC'">
                p.author_name ASC
            </when>
            <when test="sortBy == 'author_name' and sortDirection == 'DESC'">
                p.author_name DESC
            </when>
            <when test="sortDirection == 'ASC'">
                p.created_at ASC
            </when>
            <otherwise>
                p.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{size}
    </select>

    <!-- 통합 검색 카운트 -->
    <select id="countAllWithConditions" parameterType="goorm.mybatisboard.post.dto.SearchConditionDto"
            resultType="int">
        SELECT COUNT(*)
        FROM posts p

        <where>
            <!-- 키워드 검색 -->
            <if test="keyword != null and keyword.trim() != ''">
                AND (
                <choose>
                    <when test="searchType == 'title'">
                        LOWER(p.title) LIKE LOWER(CONCAT('%', #{keyword}, '%'))
                    </when>
                    <when test="searchType == 'content'">
                        LOWER(p.content) LIKE LOWER(CONCAT('%', #{keyword}, '%'))
                    </when>
                    <otherwise>
                        (LOWER(p.title) LIKE LOWER(CONCAT('%', #{keyword}, '%'))
                        OR LOWER(p.content) LIKE LOWER(CONCAT('%', #{keyword}, '%')))
                    </otherwise>
                </choose>
                )
            </if>

            <!-- 날짜 범위 검색 -->
            <if test="startDate != null">
                AND DATE(p.created_at) &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND DATE(p.created_at) &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- 카테고리 목록 조회 -->
    <select id="findAllCategories" resultType="goorm.mybatisboard.post.dto.CategoryDto">
        SELECT
            1 as id,
            '일반' as name,
            '일반 게시글' as description,
            1 as display_order,
            TRUE as is_active,
            NOW() as created_at,
            NOW() as updated_at
        UNION ALL
        SELECT
            2 as id,
            '공지사항' as name,
            '중요한 공지사항' as description,
            0 as display_order,
            TRUE as is_active,
            NOW() as created_at,
            NOW() as updated_at
        ORDER BY display_order, name
    </select>

    <!-- 활성 카테고리만 조회 -->
    <select id="findActiveCategories" resultType="goorm.mybatisboard.post.dto.CategoryDto">
        SELECT
            1 as id,
            '일반' as name,
            '일반 게시글' as description,
            1 as display_order,
            TRUE as is_active
        UNION ALL
        SELECT
            2 as id,
            '공지사항' as name,
            '중요한 공지사항' as description,
            0 as display_order,
            TRUE as is_active
        ORDER BY display_order, name
    </select>

</mapper>